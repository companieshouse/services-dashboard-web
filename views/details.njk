{% extends "layout.njk" %}
{% set active = "details" %}

{% from "macros.njk" import addDaysAgo, setLanguage, sonarLink, depTrackLink, DepTrackMetrics, dropdownFilter %}

{% block content %}
<div class="columns">
  <div class="column is-3">
      <!-- Master checkbox to control all .level1-checkbox -->
      <div class="masterCheckbox">
        <input type="checkbox" id="masterCheckbox-id">
        <label for="masterCheckbox-id"><strong>Select All</strong></label>
        <hr>
      </div>
      <form id="filterForm">
         {% for document in documents %}
            {% if document %}
                  <div class="no-wrap-inline-contents">
                  <input type="checkbox" id="{{ document.name }}" class="level1-checkbox" checked>
                  <label for="{{ document.name }}">{{ document.name }}</label>
                  <div class="no-wrap-inline-contents">
                     {% for version in document.versions %}
                        {% if version %}
                           <input type="checkbox" id="{{ document.name }}-{{ version.version }}" class="ml-4" data-level1="{{ document.name }}" checked>
                           <label for="{{ document.name }}-{{ version.version }}">{{ version.version }}</label><br>
                        {% endif %}
                     {% endfor %}
                  </div>
               </div>
            {% endif %}
         {% endfor %}
      </form>
  </div>

  <div class="column table-container">
    <table class="table">
         <thead>
         <!-- Col Headers -->
            <tr>
                  <!--  1 --><th class="row-header-title header-service" id="col-head-service" data-type="string"> Service</th>

                  <!--  2 --><th class="row-header-title header-version" id="col-head-deptk-version"   data-type="string">(SBOM) Version</th>
                  <!--  3 --><th class="row-header-title header-deptrack"  id="col-head-deptk-date" data-type="date">(SBOM) date</th>
                  <!--  4 --><th class="row-header-title header-version" id="col-head-deptk-runtime"   data-type="string">Runtime</th>


                  <!--  5 --><th class="row-header-title header-git" id="col-head-git-owner"    data-type="string"> Owner</th>
                  <!--  6 --><th class="row-header-title header-git" id="col-head-git-lang"     data-type="string"> Lang</th>
                  <!--  7 --><th class="row-header-title header-git" id="col-head-git-rel-last" data-type="string"> Last Release</th>
                  <!--  8 --><th class="row-header-title header-git" id="col-head-git-rel-date" data-type="date">   Date</th>

                  <!-- 15 --><th class="row-header-title header-ecs" id="col-head-ecs-live"    data-type="string">Sonar</th>

           
                  <!-- 13 --><th class="row-header-title header-ecs" id="col-head-ecs-cidev"   data-type="string"><span>CI Dev</span></th>
                  <!-- 14 --><th class="row-header-title header-ecs" id="col-head-ecs-stag"    data-type="string"><span>Staging</span></th>
                  <!-- 15 --><th class="row-header-title header-ecs" id="col-head-ecs-live"    data-type="string"><span>Live</span></th>
                  
                  <!-- 15 --><th class="row-header-title header-ecs" id="col-head-ecs-live"    data-type="string"><span>Dependencies</span></th>
            </tr>
         </thead>
         <tbody>
         {% for document in documents %}
            {% if document %}
               <!-- Iterate over each version entry in versions array -->
               {% for version in document.versions %}
                  {% if version %}
                     <tr data-level1="{{ document.name }}" data-level2="{{ version.version }}">
                           <!-- 1st Column (link) -->
                           <td class="td-name"><a href="{{ document.gitInfo.repo }}">{{ document.name }}</a></td>

                           <!-- 3 Columns Version/Date & Runtime-->
                           <td class="td-version">{{ version.version }}</td>
                           <td class="td-bom-import"><span>{{ depTrackLink(depTrackUri, version.lastBomImport | date("YYYY-MM-DD"), version.uuid) }}</span><br>{{addDaysAgo( version.lastBomImport ) }}</td>
                           <td class="td-runtime">
                              {% if version.runtime.length > 1 %}
                                <ul> 
                                  {% for info in version.runtime %}
                                    <li><span class="tag is-info">{{ info }}</span></li>
                                  {% endfor %}
                                </ul>
                              {% else %}
                                 {{ version.runtime[0] }}
                              {% endif %}
                           </td>

                           <!-- 4 Columns (Git info)-->
                           <td class="td-git-owner">     <a href="{{ document.gitInfo.repo }}/custom-properties">{{ document.gitInfo.owner }}</a></td>
                           <td class="td-git-lang">      {{setLanguage(version.lang, document.gitInfo.lang, document.gitInfo.repo) }}</td>
                           <td class="td-git-version">   <a href="{{ document.gitInfo.repo }}/releases">         {% for release in document.gitInfo.releases %} {% if release %}<li>{{ release.version }}</li> {% endif %}{% endfor %} </a></td>
                           <td class="td-git-date"><span><a href="{{ document.gitInfo.repo }}/releases">         {{ document.gitInfo.releases[0].date | date("YYYY-MM-DD") }}</a></span><br>{{addDaysAgo( document.gitInfo.releases[0].date ) }}</td>

                           <!-- 4 Columns (sonar Metrics) -->
                           <td>
                              <div class="level">
                                {% if document.sonarMetrics %}
                                  {{ sonarLink(sonarUri, document.sonarKey, document.sonarMetrics.coverage, "coverage", "is-success", "Coverage") }}
                                  {{ sonarLink(sonarUri, document.sonarKey, document.sonarMetrics.bugs, "bugs", "is-danger", "Bugs") }}
                                  {{ sonarLink(sonarUri, document.sonarKey, document.sonarMetrics.vulnerabilities, "vulnerabilities", "is-warning", "Vulnerabilities") }}
                                  {{ sonarLink(sonarUri, document.sonarKey, document.sonarMetrics.code_smells, "code smells", "is-info", "Smells") }}
                                {% endif %}
                              </div>
                           </td>

                           <!-- 3 Columns ECS -->
                           <td class="td-ecs">
                              {{ document.ecs.cidev.version }}
                           </td>
                           <td class="td-ecs">
                              {{ document.ecs.staging.version }}
                           </td>
                           <td class="td-ecs">
                              {{ document.ecs.live.version }}
                           </td>

                           <!-- Dep Track -->
                           <td>
                              <div class="level">
                                {{DepTrackMetrics(depTrackUri, version.metrics.critical, "critical", version.uuid, "#", "is-danger", "Critical")}}
                                {{DepTrackMetrics(depTrackUri, version.metrics.high, "high", version.uuid, "#", "is-warning", "High")}}
                                {{DepTrackMetrics(depTrackUri, version.metrics.medium, "medium", version.uuid, "#", "is-info", "Medium")}}
                                {{DepTrackMetrics(depTrackUri, version.metrics.low, "low", version.uuid, "#", "is-white", "Low")}}
                                {{DepTrackMetrics(depTrackUri, version.metrics.vulnerabilities, "vulnerabilities", version.uuid, "#", "is-white", "Vulnerabilities")}}
                                {{DepTrackMetrics(depTrackUri, version.metrics.components, "components", version.uuid, "components", "is-white", "Components")}}
                              </div>
                           </td>
                     </tr>
                  {% endif %}
               {% endfor %}
            {% endif %}
         {% endfor %}
         </tbody>
    </table>
  </div>
</div>


<script>
document.getElementById("masterCheckbox-id").addEventListener("change", function() {
  const allCheckboxes = document.querySelectorAll("#filterForm input[type='checkbox']");
  allCheckboxes.forEach(cb => cb.checked = this.checked);

  // Trigger the visibility update
  const event = new Event('change');
  document.querySelectorAll(".level1-checkbox, .ml-4").forEach(cb => cb.dispatchEvent(event));
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
  const tableRows = document.querySelectorAll("tbody tr");
  const level1Checkboxes = document.querySelectorAll(".level1-checkbox");
  const level2Checkboxes = document.querySelectorAll(".ml-4");

  // Helper: update table visibility
  function updateTableVisibility() {
    tableRows.forEach(row => {
      const level1 = row.dataset.level1;
      const level2 = row.dataset.level2;
      const level1Checked = document.querySelector(`#${CSS.escape(level1)}`)?.checked;
      const level2Checkbox = document.querySelector(`#${CSS.escape(level1)}-${CSS.escape(level2)}`);
      const level2Checked = level2Checkbox ? level2Checkbox.checked : true;

      if (level1Checked && level2Checked) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  }

  // When a level-1 checkbox (service) is toggled
  level1Checkboxes.forEach(cb => {
    cb.addEventListener("change", function() {
      const service = this.id;
      const childCheckboxes = document.querySelectorAll(`input[data-level1="${CSS.escape(service)}"]`);

      // Check/uncheck all children
      childCheckboxes.forEach(child => {
        child.checked = this.checked;
      });

      updateTableVisibility();
    });
  });

  // When a level-2 checkbox (version) is toggled
  level2Checkboxes.forEach(cb => {
    cb.addEventListener("change", function() {
      const service = this.dataset.level1;

      // If all level2 are unchecked, uncheck parent
      const all = document.querySelectorAll(`input[data-level1="${CSS.escape(service)}"]`);
      const checked = Array.from(all).some(c => c.checked);
      document.querySelector(`#${CSS.escape(service)}`).checked = checked;

      updateTableVisibility();
    });
  });

  // Initial filter
  updateTableVisibility();
});
</script>

{% endblock %}