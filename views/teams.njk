{% extends "layout.njk" %}
{% set active = "teams" %}
{% from "macros.njk" import addDaysAgo, sonarLink, depTrackLink, DepTrackMetrics, setStandardId, addCoverageColorClass %}

{% macro gitReleaseInfo(version, ReleaseDate, min, max, repoLink) %}
   {% if ReleaseDate %}
      {% set ReleaseDate = ReleaseDate | date("YYYY-MM-DD") %}
   {% else %}
      {% set ReleaseDate = "no date loaded" %}
   {% endif %}

   <li title="{{ ReleaseDate }}">
      <p>{{ version }}</p>{{addDaysAgo( ReleaseDate ) }}
   </li>
{% endmacro %}

{% macro addSonarColorClass(bugs, coverage) %}
   {% if coverage == 0 %}
      has-background-warning-light
   {% else %}
    {% if bugs == 0 %}
        has-background-success-light
    {% elseif bugs < 10 %}
        has-background-warning-light
    {% else %}
        has-background-danger-light
    {% endif %}
   {% endif %}
{% endmacro %}

{% macro addDepTrackColorClass(critical, high, medium) %}
   {% if critical != 0 %}
      has-background-danger-light
   {% elseif high != 0 or medium != 0 %}
      has-background-warning-light
   {% else %}
      has-background-success-light
   {% endif %}
{% endmacro %}

{% block content %}
    <div class="field mb-4">
        <div class="control has-icons-left">
            <label for="table-search">
                Search: 
            </label>
            <input
                id="table-search"
                class="input"
                type="text"
                placeholder="Search table..."
            >
        </div>
    </div>
    <div class="columns">
        <div class="column is-narrow">
            <!-- Master checkbox to control all .level1-checkbox -->
            <div class="masterCheckbox">
                <input type="checkbox" id="masterCheckbox-id" checked>
                <label for="masterCheckbox-id"><strong>Select All</strong></label>
                <hr>
            </div>

            <form id="filterForm">
            {% for document in documents %}
                {% if document %}
                {% set standardId = setStandardId(document._id) %}

                <div class="no-wrap-inline-contents">
                    <input type="checkbox" id="{{ standardId }}" class="level1-checkbox" checked>
                    <label for="{{ standardId }}" class="label-level1-checkbox">{{ document._id }} ({{ document.servicesCount }})</label>
                </div>
                {% endif %}
            {% endfor %}
            </form>
        </div>

        <div class="column table-container">
            <table id="tab-table-id" class="table is-striped is-fullwidth is-hoverable">
            <thead>
                <tr>
                <th class="row-header-title header-service" id="col-head-service">Service</th>
                <th class="row-header-title header-git" id="col-head-git-lang">Runtime</th>
                <th class="row-header-title header-ecs" id="col-head-ecs-cidev">CI Dev</th>
                <th class="row-header-title header-ecs" id="col-head-ecs-stag">Staging</th>
                <th class="row-header-title header-ecs" id="col-head-ecs-live">Live</th>
                <th class="row-header-title header-sonar-metric" id="col-head-sonar-coverage">Sonar</th>
                <th class="row-header-title header-deptrack" id="col-head-deptrack">Dependencies</th>
                </tr>
            </thead>

            <tbody>
                {% for document in documents %}
                {% if document %}
                    {% for service in document.services %}
                    {% if service %}
                        {% set depTrackCritical = service.latestVersion.metrics.critical %}
                        {% set depTrackHigh     = service.latestVersion.metrics.high %}
                        {% set depTrackMedium   = service.latestVersion.metrics.medium %}
                        {% set depTrackLow      = service.latestVersion.metrics.low %}
                        <tr class="transparent_row"
                            data-level1="{{ setStandardId(document._id) }}"
                            data-level2="{{ service.name }}"
                            data-critical="{{ depTrackCritical }}"
                            data-high="{{ depTrackHigh }}"
                            data-medium="{{ depTrackMedium }}"
                            data-low="{{ depTrackLow }}"
                        >
                        <td class="td-name">
                            <div class="is-flex-direction-row is-justify-content-space-between">
                                <a href="{{basePath}}/service/{{ service.name }}">{{ service.name }}</a>
                                <span>- {{ document._id }}</span>
                            </div>
                        </td>
                        
                        <td class="td-runtime">
                            {% for info in service.latestVersion.runtime.runtime %}
                                {% if info %}
                                {% if info.color == "red" %}
                                    <span class="tag is-danger">{{ info.value }}</span>
                                {% elseif info.color == "green" %}
                                    <span class="tag is-success">{{ info.value }}</span>
                                {% elseif info.color == "yellow" %}
                                    <span class="tag is-warning">{{ info.value }}</span>
                                {% elseif info.color == "none" %}
                                    <span class="tag is-info">{{ info.value }}</span>
                                {% endif %}
                                {% endif %}
                            {% endfor %}
                        </td>

                        <!-- CI DEV -->
                        <td class="td-ecs">
                            <ul class="td-git-version-info">
                            {% if service.ecs.cidev.version %}
                                {{ gitReleaseInfo(
                                service.ecs.cidev.version,
                                service.ecs.cidev.gitReleaseDate,
                                thresholdsCidev[0],
                                thresholdsCidev[1],
                                service.gitInfo.repo
                                ) }}
                            {% endif %}
                            </ul>
                        </td>

                        <!-- STAGING -->
                        <td class="td-ecs">
                            <ul class="td-git-version-info">
                            {% if service.ecs.staging.version %}
                                {{ gitReleaseInfo(
                                service.ecs.staging.version,
                                service.ecs.staging.gitReleaseDate,
                                thresholdsStaging[0],
                                thresholdsStaging[1],
                                service.gitInfo.repo
                                ) }}
                            {% endif %}
                            </ul>
                        </td>

                        <!-- LIVE -->
                        <td class="td-ecs">
                            <ul class="td-git-version-info">
                            {% if service.ecs.live.version %}
                                {{ gitReleaseInfo(
                                service.ecs.live.version,
                                service.ecs.live.gitReleaseDate,
                                thresholdsLive[0],
                                thresholdsLive[1],
                                service.gitInfo.repo
                                ) }}
                            {% endif %}
                            </ul>
                        </td>

                        <!-- SONAR -->
                        {% set sonarBugs = service.sonarMetrics.bugs %}
                        {% set coverage = service.sonarMetrics.coverage %}
                        <td class="td-sonar-metrics {{ addSonarColorClass(sonarBugs, coverage) }}">
                            {% if service.sonarMetrics %}
                                {% if coverage == 0 %}
                                    <progress class="progress" value="0" max="100" data-tooltip="Unknown Coverage">
                                        0
                                    </progress>
                                {% else %}
                                    <progress class="progress {{ addCoverageColorClass(coverage) }} has-tooltip" value="{{coverage}}" max="100" data-tooltip="{{ coverage }}% Overall Coverage">
                                        {{ coverage }}
                                    </progress>
                                {% endif %}
                                <div class="level">
                                    <span class="tag level-item is-danger has-tooltip-bottom" data-tooltip="Vulnerabilities">
                                        {{ service.sonarMetrics.vulnerabilities }}
                                    </span>
                                    <span class="tag level-item is-warning has-tooltip-bottom" data-tooltip="Bugs">
                                        {{ sonarBugs }}
                                    </span>
                                    <span class="tag level-item is-info has-tooltip-bottom" data-tooltip="Code Smells">
                                        {{ service.sonarMetrics.code_smells }}
                                    </span>
                                </div>
                            {% endif%}
                        </td>

                        <!-- DEP TRACK -->
                        {% set uuid             = service.latestVersion.uuid %}
                        <td class="td-deptrack-metrics {{ addDepTrackColorClass(depTrackCritical, depTrackHigh, depTrackMedium) }}">
                            {% if service.latestVersion.metrics %}
                                <div class="level">
                                    <span class="tag level-item tag has-background-danger-30 has-text-white has-tooltip has-tooltip-bottom" data-tooltip="Critical">
                                        <a class="has-text-white" href="{{depTrackUri}}/projects/{{uuid}}/findings">
                                            {{ depTrackCritical }}
                                        </a>
                                    </span>
                                    <span class="tag level-item is-danger has-tooltip-bottom" data-tooltip="High">
                                        <a class="has-text-black" href="{{depTrackUri}}/projects/{{uuid}}/findings">
                                            {{ depTrackHigh }}
                                        </a>
                                    </span>
                                    <span class="tag level-item is-warning has-tooltip-bottom" data-tooltip="Medium">
                                        <a class="has-text-black" href="{{depTrackUri}}/projects/{{uuid}}/findings">
                                            {{ depTrackMedium }}
                                        </a>
                                    </span>
                                    <span class="tag level-item is-success has-tooltip-bottom" data-tooltip="Low">
                                        <a class="has-text-black" href="{{depTrackUri}}/projects/{{uuid}}/findings">
                                            {{ depTrackLow }}
                                        </a>
                                    </span>
                                </div>
                            {% endif %}
                        </td>
                        </tr>
                    {% endif %}
                    {% endfor %}
                {% endif %}
                {% endfor %}
            </tbody>
            </table>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const master = document.getElementById("masterCheckbox-id");
  const checkboxes = [...document.querySelectorAll(".level1-checkbox")];
  const rows = [...document.querySelectorAll("#tab-table-id tbody tr")];
  const searchInput = document.getElementById("table-search");

  // Apply filters based on selected teams and search term
  function filter() {
    const activeTeams = new Set(checkboxes.filter(cb => cb.checked).map(cb => cb.id));
    const searchTerm = searchInput.value.toLowerCase().trim();

    rows.forEach(row => {
      const matchesTeam = activeTeams.has(row.dataset.level1);
      const matchesSearch = row.innerText.toLowerCase().includes(searchTerm);
      row.style.display = (matchesTeam && matchesSearch) ? "" : "none";
    });
  }

  // Master checkbox toggles all
  master.addEventListener("change", () => {
    checkboxes.forEach(cb => cb.checked = master.checked);
    filter();
  });

  // Individual team filters
  checkboxes.forEach(cb => cb.addEventListener("change", filter));

  // Search input filter (real-time)
  searchInput.addEventListener("input", filter);

  filter(); // initial render

  /* -------------------------------------------------------------------------- */
  /* SORTING BY DEPENDENCIES                                                    */
  /* -------------------------------------------------------------------------- */

  const depHeader = document.querySelector("#col-head-deptrack");
  const tableBody = document.querySelector("#tab-table-id tbody");

  let sortDirection = "desc"; // toggle between desc â†’ asc

  depHeader.style.cursor = "pointer";  
  depHeader.title = "Sort by Dependencies";

  depHeader.addEventListener("click", () => {
    const rows = [...tableBody.querySelectorAll("tr")];

    rows.sort((a, b) => {
      const aVals = [
        Number(a.dataset.critical),
        Number(a.dataset.high),
        Number(a.dataset.medium),
        Number(a.dataset.low)
      ];
      const bVals = [
        Number(b.dataset.critical),
        Number(b.dataset.high),
        Number(b.dataset.medium),
        Number(b.dataset.low)
      ];

      // multi-level compare function
      for (let i = 0; i < 4; i++) {
        if (aVals[i] !== bVals[i]) {
          return sortDirection === "desc"  
            ? bVals[i] - aVals[i]
            : aVals[i] - bVals[i];
        }
      }
      return 0;
    });

    // Append rows back in new order
    rows.forEach(row => tableBody.appendChild(row));

    // Toggle sort direction
    sortDirection = sortDirection === "desc" ? "asc" : "desc";
  });
});
</script>

{% endblock %}
