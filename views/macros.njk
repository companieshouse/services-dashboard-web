{# set a standard id (e.g. remove unallowed chars (currently spaces)
   Note the {%- ... -%} syntax, which removes unnecessary whitespace added by nunjucks
#}
{% macro setStandardId(id) -%}
    {%- set validId = id | replace(' ', '-') | lower | trim -%}
    {{- validId -}}
{%- endmacro %}

{% macro addDaysAgo (date) %}
   {% set value = date | daysAgo %}
      {% if value %}
         <span class="days-ago"> ({{ value }})</span>
      {% endif %}
{% endmacro %}

{% macro sonarLink(sonarUri, sonarKey, val, name, style, tooltip) %}
   <span title="{{ name }}" class="tag level-item {{style}} has-tooltip-bottom" data-tooltip={{tooltip}}>
      {% if sonarKey %}
         <a class="sonar-link" href="{{ sonarUri }}/dashboard?id={{ sonarKey | urlencode }}">{{val}}</a>
      {% else %}
         {{ val }}
      {% endif %}
   </span>
{% endmacro %}

{% macro depTrackLink(depTrackUri, metricVal, uuid, arg) %}
    {% if uuid %}
        <a class="deptrack-link has-text-black" href="{{ depTrackUri }}/projects/{{ uuid }}/{{ arg }}">{{metricVal}}</a>
    {% else %}
        {{ metricVal }}
    {% endif %}
{% endmacro %}

{% macro DepTrackMetrics(depTrackUri, metricVal, metricClass, uuid, arg, style, tooltip) %}
    {% if metricVal != 0 %}
      <div class="rounded-number dt-metric-{{ metricClass }}-back">
    {% else %}
      <div class="front-number dt-metric-{{ metricClass }}-front">
    {% endif %}
      <span title={{ metricClass }} class="tag level-item {{style}} has-tooltip-bottom" data-tooltip={{ tooltip }}>
         {{depTrackLink(depTrackUri, metricVal, uuid, arg)}}
      </span>      
      </div>
{% endmacro %}

{#
macro to create a unique sorted list of values for a given field in a collection:
- collection: the array to loop over (ex. "documents")
- field: the nested property to extract unique values from (ex "-----.gitInfo.owner")

The sorted list is saved into a global variable "uniqueSortedValues"
which allows this macro to be reused to create dropdown or radiobutton filters
 #}

{% macro getListUniqueValues(collection, field) %}
   {% set uniqueValues = [] %}

   {% for item in collection %}
     {# split the field into keys  (ex. "gitInfo.owner" ==>  ["gitInfo", "owner"]) #}
      {% set keys = field.split('.') %}
      {% set value = item %}
      {% for key in keys %}
            {% if value[key] is defined %}
               {% set value = value[key] %}
            {% else %}
               {% set value = '' %}
            {% endif %}
      {% endfor %}

      {% if value and value not in uniqueValues %}
            {% set _ = uniqueValues.push(value) %}
      {% endif %}
   {% endfor %}

   {# Sort the unique values #}
   {{ uniqueValues | sort | setGlobal('uniqueSortedValues') }}
{% endmacro %}


{% macro addCoverageColorClass(coverage) %}
   {% if coverage >= 75 %}
      is-success
   {% elseif coverage >= 50  %}
      is-warning
   {% else %}
      is-danger
   {% endif %}
{% endmacro %}


{% macro addVulnerabilityKey(containerStyle, elementStyle) %}
<div>
      <p class="has-text-weight-semibold">Dependency Track Key:</p>
      <div class="is-flex {{containerStyle}} is-justify-content-space-around">
         <span class="{{elementStyle}} tag has-background-danger-30 has-text-white">Critical</span>
         <span class="{{elementStyle}} tag is-danger">High</span>
         <span class="{{elementStyle}} tag is-warning">Medium</span>
         <span class="{{elementStyle}} tag is-success">Low</span>
         <span class="{{elementStyle}} tag">Components</span>
      </div>
</div>
{% endmacro %}